/* Scratchcard - A scratch card library based on canvas
 * @author kikoshoung (kikoshoung@gmail.com)
 * last modified at 2014-01-22 09:56:07
 */
(function(){function t(t){this.options=t,this.scratchActivated=!1,this.extendOptions(),this.initialize()}function e(t){if("object"!=typeof t||!t||t.nodeType)return t;var e=t.constructor===Array?[]:{};for(var n in t)e[n]=arguments.callee(t[n]);return e}function n(t,n){var i=e(n);for(var o in t)i[o]=i[o]instanceof Object&&t[o]?i[o]instanceof Array?e(t[o]):arguments.callee(t[o],i[o]):t[o];return i}function i(t){for(var e=[t.offsetLeft,t.offsetTop],n=t.offsetParent;n;)e[0]+=n.offsetLeft,e[1]+=n.offsetTop,n=n.offsetParent;return e}var o="ontouchstart"in window?!1:!0;t.prototype={defaults:{container:null,imgSrc:"",size:[240,180],percentage:.6,scratchLayer:{background:"#E0E0E0",text:"\u522e\u5f00\u6b64\u6d82\u5c42",color:"#888",font:"30px Verdana",lineWidth:30},notSupportText:"Sorry, your browser dose not support [Canvas], please use a higher version browser and try again.",onScratch:null,onComplete:null},events:{mousedown:o?"mousedown":"touchstart",mousemove:o?"mousemove":"touchmove",mouseup:o?"mouseup":"touchend"},extendOptions:function(){this.options=n(this.options,this.defaults)},initialize:function(){var t=this.options,e=this;this.isOptionsAvailable(t)&&this.setImage(t,function(){e.setContainer(t),e.setCanvas(t),e.initCanvas(),e.bindEvents()})},isOptionsAvailable:function(t){var e=t.container,n=t.imgSrc,i=t.size,o=t.validArea,s=t.percentage;if(!e||!e.nodeType||1!=e.nodeType)throw Error("Param [container] must be given and must be a dom element.");if(!n||"string"!=typeof n)throw Error("Param [imgSrc] must be given and must be a string.");if(i&&!(i instanceof Array))throw Error("Param [size] must be an array like [{width}, {height}].");if(o&&!(o instanceof Array))throw Error("Param [validArea] must be an array like [{left}, {top}, {width}, {height}].");if(s&&"number"!=typeof s&&"string"!=typeof s)throw Error('Param [percentage] must be a number or string like 0.8 or "0.8".');return!0},setContainer:function(t){var e=t.container,n=(this.curSize,"display: inline-block; position: relative;");e.innerHTML="",e.style.cssText=n,e.style.width=this.curSize[0]+"px",e.style.height=this.curSize[1]+"px",this.container=e},setImage:function(t,e){var n=new Image,i=this,o="position: relative; z-index: 1; vertical-align: middle;";n.onload=function(){var s=i.getCurSize(t);i.origSize=[n.width,n.height],i.curSize=s,n.width=s[0],n.height=s[1],e&&e(),n.style.cssText=o,t.container.appendChild(n)},n.src=t.imgSrc,this.img=n},setCanvas:function(t){var e=t.container,n=document.createElement("canvas"),i="position: absolute; z-index: 2; top: 0; left: 0;";n.innerHTML=t.notSupportText,n.style.cssText=i,n.width=n.style.width=this.curSize[0],n.height=n.style.height=this.curSize[1],e.appendChild(n),this.canvas=n},setCanvasToErrorMode:function(){var t=this.defaults.scratchLayer;this.canvas.style.background=t.background,this.canvas.style.color=t.color},getCurSize:function(t){var e=t.size,n=t.origSize;return(e||n).slice()},getScratchedPercentage:function(){for(var t=this.ctx,e=this.canvas,n=this.options,i=n.validArea||[0,0,e.width,e.height],o=t.getImageData.apply(t,i).data,s=0,r=0,a=o.length;a>r;r+=4)0==o[r+3]&&s++;return s/(a/4)},getCoordinate:function(t){return t.targetTouches&&(t=t.targetTouches[0]),[t.pageX,t.pageY]},initCanvas:function(){var t,e=this.canvas,n=this.options,i=n.scratchLayer;try{t=this.ctx=e.getContext("2d")}catch(o){throw this.setCanvasToErrorMode(),Error(n.notSupportText)}t.globalCompositeOperation="source-over",t.fillStyle=i.background,t.fillRect(0,0,e.width,e.height),t.font=i.font,t.textBaseline="middle",t.textAlign="center",t.fillStyle=i.color,t.fillText(i.text,e.width/2,e.height/2),t.strokeStyle="rgba(255, 255, 255, 1)",t.lineJoin="round",t.lineCap="round",t.lineWidth=i.lineWidth},bindEvents:function(){var t=this.canvas,e=this.container,n=this.events,i=this;t.addEventListener(n.mousedown,function(t){i.mousedownHandler(t)}),t.addEventListener(n.mousemove,function(t){i.mousemoveHandler(t)}),t.addEventListener(n.mouseup,function(t){i.mouseupHandler(t),i.isOktoShowAll(i.getScratchedPercentage())}),t.addEventListener("mouseout",function(t){i.mouseoutHandler(t)}),e.addEventListener(n.mousemove,function(t){t.preventDefault()})},mousedownHandler:function(t){var e=this.ctx,n=this.canvas,o=this.canvasOffset||(this.canvasOffset=i(n)),s=this.getCoordinate(t);this.scratchActivated=!0,e.beginPath(),e.moveTo(s[0]-o[0],s[1]-o[1])},mousemoveHandler:function(t){if(this.scratchActivated){var e=this.ctx,n=this.canvas,i=this.canvasOffset,o=this.getCoordinate(t);e.lineTo(o[0]-i[0],o[1]-i[1]),e.globalCompositeOperation="destination-out",e.stroke(),n.style.opacity=n.style.opacity?"":"0.999"}},mouseupHandler:function(){var t=this.ctx,e=this.options.onScratch;this.scratchActivated=!1,t.closePath(),e&&e(this.getScratchedPercentage())},mouseoutHandler:function(){this.scratchActivated=!1},isOktoShowAll:function(t){var e=this.options,n=e.onComplete;t>=e.percentage&&(this.showAll(),n&&n())},showAll:function(){this.canvas.style.display="none"},destroy:function(){var t=this.container,e=this.canvas,n=this.img;t.removeChild(e),t.removeChild(n),e.removeEventListener(events.mousedown),e.removeEventListener(events.mousemove),e.removeEventListener(events.mouseup),e.removeEventListener("mouseout"),t.removeEventListener(events.mousemove)}},window.ScratchCard=t})();